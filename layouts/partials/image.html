{{- $p      := .page -}}
{{- $meta   := .image -}}                   {{/* expects { path, alt?, caption? } */}}
{{- $fallback := .fallback -}}

{{- $file          := $meta.path | default "" -}}
{{- $fallbackPath  := cond (and $fallback (isset $fallback "path")) ($fallback.path | default "") "" -}}
{{- $fallbackWidth := cond (and $fallback (isset $fallback "width")) ($fallback.width | default 0) 0 -}}
{{- $fallbackHeight := cond (and $fallback (isset $fallback "height")) ($fallback.height | default 0) 0 -}}

{{- $res  := cond (and $p $file) ($p.Resources.GetMatch $file) nil -}}
{{- $twic := site.Params.Twic | default site.Params.twic -}}

{{- $src := "" -}}
{{- $width := 0 -}}
{{- $height := 0 -}}
{{- $rel := "" -}}

{{- if $res -}}
  {{- $src = $res.RelPermalink -}}
  {{- $width = $res.Width -}}
  {{- $height = $res.Height -}}
  {{- $rel  = strings.TrimPrefix "/" $res.RelPermalink -}}   {{/* Twic likes paths without leading slash */}}
{{- else if $fallbackPath -}}
  {{- $src = $fallbackPath -}}
  {{- $width = $fallbackWidth -}}
  {{- $height = $fallbackHeight -}}
  {{- $rel  = strings.TrimPrefix "/" $fallbackPath -}}
{{- end -}}

{{- if $src -}}
  {{- $idSeed       := printf "%s:%s" $rel (cond $p $p.Path "global") -}}
  {{- $hex          := replace (printf "%x" (hash.FNV32a (print $idSeed ":js"))) "-" "" -}}
  {{- $noscriptHex  := replace (printf "%x" (hash.FNV32a (print $idSeed ":noscript"))) "-" "" -}}

  <figure{{ if or .class .ratio .helper }} class="{{ if .class }}[ {{ .class }} ]{{ end }}{{ if or .ratio .helper }}[ {{ if .ratio }}ratio--{{ .ratio }} {{ end }}{{ if .helper }}{{ .helper }} {{end}}]{{end}}"{{end}} data-script>
    <picture id="image-{{ $hex }}" class="[ bg ]">
      <img
        data-twic-src="image:{{ $src }}"
        data-twic-focus="auto"
        alt="{{ $meta.alt | default $p.Title }}"
        width="{{ $width }}"
        height="{{ $height }}"
      />
    </picture>
    {{ with .caption }}<figcaption>{{ . }}</figcaption>{{ end }}
  </figure>

  <noscript>
    <figure{{ if or .class .ratio .helper }} class="{{ if .class }}[ {{ .class }} ]{{ end }}{{ if or .ratio .helper }}[ {{ if .ratio }}ratio--{{ .ratio }} {{ end }}{{ if .helper }}{{ .helper }} {{end}}]{{end}}"{{end}}>
      <picture id="image-{{ $noscriptHex }}" class="[ bg ]">
        <img
          src="https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/focus=auto"
          alt="{{ $meta.alt | default $p.Title }}"
          width="{{ $width }}"
          height="{{ $height }}"
        />
      </picture>
      {{ with .caption }}<figcaption>{{ . }}</figcaption>{{ end }}
    </figure>
  </noscript>

  <style>
    /* scripted bg preview */
    #image-{{ $hex }} {
      background-image: url('https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/output=preview');
    }
    /* noscript bg preview */
    #image-{{ $noscriptHex }} {
      background-image: url('https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/focus=auto/output=preview');
    }
    #image-{{ $noscriptHex }} > img { opacity: 1; }
  </style>
{{- else -}}
  {{- warnf "No image found: %q (fallback: %q) on page %q (is it a page bundle file?)" $file $fallbackPath (cond $p $p.Path "unknown") -}}
  {{/* quiet fail: render nothing */}}
{{- end -}}
