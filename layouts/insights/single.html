{{- define "main" -}}
{{- .Store.Set "hasTwic" true -}}
<article class="[ post-single post-grid h-entry ][ row-gap--3 section--padding-top ]">
  <div class="[ post-grid post-breakout ]">
    {{ partial "breadcrumbs.html" . }}
    <header class="[ post__header post-grid post-breakout ]">
      <h1>{{ .Title }}</h1>
      {{- $format := "January 2, 2006" -}}
      {{- $iso := "2006-01-02T15:04:05Z07:00" -}}
      {{- $timeFormat := "3:04pm" -}}
      
      {{- $published := .Date -}}
      {{- $lastModified := .Lastmod | default .Date -}}
      {{- $hourDiff := div (sub $lastModified.Unix $published.Unix) 3600 -}}
      <p class="[ meta{{ if .Params.feature.image }} meta--spaced{{ end }} ]">
        {{- $categoryLabels := dict "Trade-Industry" "Trade & Industry" "Logistics-Supply Chain" "Logistics & Supply Chain" -}}
        {{ range sort .Params.categories }}
        <span><a href="{{ "/categories/" | relURL }}{{ . | urlize }}">{{- index $categoryLabels . | default . -}}</a></span>
        {{ end }}
        | <time datetime="{{ $published.Format $iso }}">
            {{ $published.Format $format }}
          </time>
        | {{ .ReadingTime }} min read
      </p>
  
      {{- with .Params.feature -}}
      {{- if .image -}}
      {{- $image := (printf "/uploads/%s" .image) -}}
      <figure class="[ post-grid post-breakout row-gap--0.5 pb--2 ]">
        <picture id="feature" class="[ post-breakout ratio--16:9 ][ bg ]">
          <style>#feature { background-image: url('https://{{ $.Site.Params.twic }}.twic.pics{{ $image }}?twic=v1/output=preview'); }</style>
          <img data-twic-src="image:{{ $image }}" data-twic-focus="auto" alt="{{ if .alt }}{{ .alt }}{{ end }}" width="{{ .Width }}" height="{{ .Height }}"/>
          <noscript>
          <img class="[ script ]" src="https://{{ $.Site.Params.twic }}.twic.pics{{ $image }}?twic=v1/output=preview" alt="{{ if .alt }}{{ .alt }}{{ end }}" width="{{ .Width }}" height="{{ .Height }}"/></noscript>
        </picture>
        {{- if .figcaption -}}
        <figcaption class="[ pt--0.5 ]">{{ .figcaption }}</figcaption>
        {{- end -}}
      </figure>
      {{- end -}}
      {{- end -}}
    </header>
    <div class="[ content ]">
      {{ .Content }}
    </div>
    <footer class="[ post-breakout ][  ]">
      {{- if gt $hourDiff 1 -}}
      <div class="[ original-publish-date ]"> 
        <p class="[ font--small ]">Last Updated: 
          <time datetime="{{ $lastModified.Format $iso }}">{{ $lastModified.Format $format }} at {{ $lastModified.Format $timeFormat }}</time>
        </p>
      </div>
      {{ end }}
      {{- partial "footnotes.html" . -}}
      {{ $current := . }}
      {{ $currentCategories := .Params.categories }}
      {{ if $currentCategories }}

        {{ $related := slice }}

        {{ range .Site.RegularPages }}
          {{ if and (in .Params.categories (index $currentCategories 0)) (ne .Permalink $current.Permalink) }}
            {{ $related = $related | append . }}
          {{ end }}
        {{ end }}

        {{ if gt (len $related) 0 }}
          {{ $related = shuffle $related }}

          <section class="[ grid row-gap--3 section--padding-top ]">
            <h2 class="[ tag-header ]">More from {{ index $currentCategories 0 }}</h2>
            <ul class="[ posts ][ grid md:col--3 gap--2 ]">
              {{ range first 2 $related }}
                <li class="[ post ]">
                  <a class="[ post__link ][ grid row-gap--0.5 ]" href="{{ .RelPermalink }}" data-prefetch>
                    <figure class="[ post__img ][ ratio--16:9 ]"></figure>
                    <div class="[ grid ]">
                      <h2 class="[ font--3 o--2 ]">{{ .LinkTitle }}</h2>
                      <div class="[ o--1 ]">
                        {{- $page := . -}}
                        {{- range sort $page.Params.categories }}
                        <small>{{- index $categoryLabels . | default . -}}</small>
                        {{- end }}
                        | <small>{{ .ReadingTime }} min read</small>
                      </div>
                      <p class="[ o--3 ]">{{ .Description | truncate 145 "[...]" | plainify }}</p>
                    </div>
                  </a>
                </li>
              {{ end }}
            </ul>
          </section>
        {{ end }}

      {{ end }}

    </footer>
  </div>
</article>
{{- end -}}
