{{- $p    := .page -}}
{{- $meta := .image | default dict -}}
{{- $file := $meta.path | default "" -}}
{{- $res  := cond (and $p $file) ($p.Resources.GetMatch $file) nil -}}
{{- if not $res }}{{- warnf "feature/image: image %q not found in %q" $file (cond $p $p.Path "unknown") }}{{- else -}}

  {{- $twic := site.Params.Twic -}}
  {{- $rel  := strings.TrimPrefix "/" $res.RelPermalink -}}
  {{- $base := printf "https://%s.twic.pics/%s?twic=v1/focus=auto" $twic $rel -}}

  {{- /* Hard cap at 1920x1080 (16:9), matching preload */ -}}
  {{- $widths := slice 480 768 1024 1280 1600 1920 -}}
  {{- $srcset := slice -}}
  {{- range $w := $widths -}}
    {{- $srcset = $srcset | append (printf "%s/cover=%dx1080 %dw" $base $w $w) -}}
  {{- end -}}
  {{- $srcset = delimit $srcset ", " -}}

  {{- $alt := $meta.alt | default $p.Title -}}

  <figure class="[ feature ][ post-grid ratio--16:9 row-gap--0.5 ]">
    <picture class="[ post-breakout ]">
      <img
        src="{{ printf "%s/cover=%dx1080" $base 1280 }}"
        srcset="{{ $srcset }}"
        sizes="100vw"
        alt="{{ $alt }}"
        width="1920" height="1080"
        decoding="async"
        loading="eager"
        fetchpriority="high"
      />
    </picture>
    {{ with $meta.figcaption }}<figcaption>{{ . }}</figcaption>{{ end }}
  </figure>

{{- end -}}
